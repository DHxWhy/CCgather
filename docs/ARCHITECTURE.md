# CCGather System Architecture

**Version:** 1.1
**Date:** 2025-01-06
**Status:** Updated

---

## 1. High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLIENT LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚   Web Application   â”‚         â”‚    CLI Package      â”‚                  â”‚
â”‚   â”‚   (Next.js 15)      â”‚         â”‚   (npx ccgather)    â”‚                  â”‚
â”‚   â”‚                     â”‚         â”‚                     â”‚                  â”‚
â”‚   â”‚  - React 19 RSC     â”‚         â”‚  - TypeScript       â”‚                  â”‚
â”‚   â”‚  - Tailwind CSS 4   â”‚         â”‚  - Commander.js     â”‚                  â”‚
â”‚   â”‚  - shadcn/ui        â”‚         â”‚  - Chalk            â”‚                  â”‚
â”‚   â”‚  - TanStack Query   â”‚         â”‚  - ccusage ì—°ë™     â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚              â”‚                               â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                               â”‚
               â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              SERVICE LAYER                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚      Vercel         â”‚  â”‚       Clerk         â”‚  â”‚  Supabase Realtime â”‚ â”‚
â”‚   â”‚   (Hosting/CDN)     â”‚  â”‚  (Authentication)   â”‚  â”‚    (WebSocket)     â”‚ â”‚
â”‚   â”‚                     â”‚  â”‚                     â”‚  â”‚                    â”‚ â”‚
â”‚   â”‚  - Edge Functions   â”‚  â”‚  - GitHub OAuth     â”‚  â”‚  - Live Updates    â”‚ â”‚
â”‚   â”‚  - ISR/SSG          â”‚  â”‚  - Session Mgmt     â”‚  â”‚  - Subscriptions   â”‚ â”‚
â”‚   â”‚  - OG Generation    â”‚  â”‚  - Webhook Events   â”‚  â”‚  - Broadcast       â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚                        â”‚                       â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                        â”‚                       â”‚
               â–¼                        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DATA LAYER                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        Supabase Platform                             â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚   â”‚   â”‚  PostgreSQL   â”‚  â”‚    Storage    â”‚  â”‚ Edge Functions â”‚           â”‚  â”‚
â”‚   â”‚   â”‚               â”‚  â”‚               â”‚  â”‚                â”‚           â”‚  â”‚
â”‚   â”‚   â”‚ - users       â”‚  â”‚ - OG cache    â”‚  â”‚ - news-crawler â”‚           â”‚  â”‚
â”‚   â”‚   â”‚ - usage_stats â”‚  â”‚ - badges      â”‚  â”‚ - ai-summarizerâ”‚           â”‚  â”‚
â”‚   â”‚   â”‚ - user_badges â”‚  â”‚ - avatars     â”‚  â”‚ - rank-calc    â”‚           â”‚  â”‚
â”‚   â”‚   â”‚ - news_items  â”‚  â”‚               â”‚  â”‚                â”‚           â”‚  â”‚
â”‚   â”‚   â”‚ - snapshots   â”‚  â”‚               â”‚  â”‚                â”‚           â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚   â”‚                                                                      â”‚  â”‚
â”‚   â”‚   Security: Row Level Security (RLS) + Service Role Key             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Technology Stack Summary

| Layer | Technology | Version | Rationale |
|-------|------------|---------|-----------|
| **Framework** | Next.js | 15.x | App Router, RSC, Streaming |
| **Runtime** | React | 19.x | Server Components |
| **Language** | TypeScript | 5.x | Type Safety |
| **Styling** | Tailwind CSS | 4.x | Utility-first, Fast builds |
| **Components** | shadcn/ui | Latest | Customizable, Accessible |
| **Auth** | Clerk | Latest | GitHub OAuth, 10K MAU Free |
| **Database** | Supabase | Latest | PostgreSQL + Realtime |
| **State (Server)** | TanStack Query | v5 | Caching, Mutations |
| **State (Client)** | Zustand | Latest | Minimal, No boilerplate |
| **Animation** | Framer Motion | 11.x | Production-ready |
| **Charts** | Recharts | 2.x | React-based, Customizable |
| **Package Manager** | pnpm | Latest | Fast, Disk efficient |
| **Hosting** | Vercel | - | Edge, ISR, Analytics |

---

## 3. Monorepo Structure

```
ğŸ“‚ ccgather/
â”‚
â”œâ”€â”€ ğŸ“‚ app/                      # Next.js App Router
â”‚   â”œâ”€â”€ ğŸ“‚ (auth)/              # Auth routes (Clerk)
â”‚   â”œâ”€â”€ ğŸ“‚ (main)/              # Main app routes
â”‚   â”‚   â””â”€â”€ ğŸ“‚ cli/auth/        # CLI OAuth callback
â”‚   â”œâ”€â”€ ğŸ“‚ (admin)/             # ğŸ”’ Admin pages (.gitignore)
â”‚   â”‚   â””â”€â”€ ğŸ“‚ admin/
â”‚   â”‚       â”œâ”€â”€ page.tsx        # Users management
â”‚   â”‚       â”œâ”€â”€ ai-usage/       # AI usage monitoring
â”‚   â”‚       â””â”€â”€ contents/       # Contents management (ON/CONFIRM/OFF)
â”‚   â”œâ”€â”€ ğŸ“‚ api/                 # API Routes
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ admin/           # Admin API endpoints
â”‚   â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”‚   â”œâ”€â”€ ai-usage/
â”‚   â”‚   â”‚   â”œâ”€â”€ contents/
â”‚   â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â””â”€â”€ crawl/
â”‚   â”‚   â””â”€â”€ ğŸ“‚ cli/auth/token/  # CLI token generation
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ globals.css
â”‚   â””â”€â”€ providers.tsx
â”‚
â”œâ”€â”€ ğŸ“‚ components/               # React Components
â”‚   â”œâ”€â”€ ğŸ“‚ ui/                  # shadcn/ui base
â”‚   â”œâ”€â”€ ğŸ“‚ layout/              # Header, Footer, Sidebar
â”‚   â”œâ”€â”€ ğŸ“‚ leaderboard/         # Leaderboard components
â”‚   â”œâ”€â”€ ğŸ“‚ profile/             # Profile components
â”‚   â”œâ”€â”€ ğŸ“‚ news/                # News components
â”‚   â””â”€â”€ ğŸ“‚ shared/              # Shared components
â”‚
â”œâ”€â”€ ğŸ“‚ lib/                      # Utilities
â”‚   â”œâ”€â”€ ğŸ“‚ supabase/            # Supabase clients
â”‚   â”œâ”€â”€ ğŸ“‚ utils/               # Helper functions
â”‚   â”œâ”€â”€ ğŸ“‚ constants/           # Static data
â”‚   â””â”€â”€ ğŸ“‚ hooks/               # Custom hooks
â”‚
â”œâ”€â”€ ğŸ“‚ packages/                 # Monorepo packages
â”‚   â””â”€â”€ ğŸ“‚ cli/                 # NPM CLI package (npx ccgather)
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ commands/
â”‚       â”‚   â”‚   â”œâ”€â”€ setup.ts    # OAuth + Stop hook install
â”‚       â”‚   â”‚   â””â”€â”€ reset.ts    # Uninstall hook
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â”œâ”€â”€ bin/
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ ğŸ“‚ supabase/                 # Database
â”‚   â”œâ”€â”€ ğŸ“‚ migrations/          # SQL migrations
â”‚   â”œâ”€â”€ ğŸ“‚ functions/           # Edge Functions
â”‚   â””â”€â”€ config.toml
â”‚
â”œâ”€â”€ ğŸ“‚ public/                   # Static assets
â”‚
â”œâ”€â”€ ğŸ“‚ internal/                 # ğŸ”’ PRIVATE (.gitignore)
â”‚   â”œâ”€â”€ ğŸ“‚ crawler/
â”‚   â”œâ”€â”€ ğŸ“‚ ai/
â”‚   â””â”€â”€ ğŸ“‚ admin/
â”‚
â”œâ”€â”€ ğŸ“‚ docs/                     # Documentation
â”‚
â”œâ”€â”€ pnpm-workspace.yaml
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

---

## 4. Data Flow

### 4.1 User Registration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚â”€â”€â”€â”€â–¶â”‚  Clerk    â”‚â”€â”€â”€â”€â–¶â”‚   Webhook    â”‚â”€â”€â”€â”€â–¶â”‚  Supabase    â”‚
â”‚ (GitHub) â”‚     â”‚  OAuth    â”‚     â”‚  (POST)      â”‚     â”‚  users table â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                                        â”‚
                      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚         â”‚
                      â–¼         â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚    Onboarding Page   â”‚
               â”‚  (Country Selection) â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 CLI Setup & Auto-Sync Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  npx ccgatherâ”‚â”€â”€â”€â”€â–¶â”‚   Browser    â”‚â”€â”€â”€â”€â–¶â”‚   Clerk      â”‚
â”‚  (setup)     â”‚     â”‚   OAuth      â”‚     â”‚   Login      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Config      â”‚â—€â”€â”€â”€â”€â”‚  API Token   â”‚â—€â”€â”€â”€â”€â”‚  Callback    â”‚
â”‚  Saved       â”‚     â”‚  Generated   â”‚     â”‚  localhost   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stop Hook   â”‚
â”‚  Installed   â”‚
â”‚  (.claude)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ (On Claude Code session end)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ccusage     â”‚â”€â”€â”€â”€â–¶â”‚  Parse Data  â”‚â”€â”€â”€â”€â–¶â”‚  POST /api   â”‚
â”‚  Output      â”‚     â”‚  + Token     â”‚     â”‚  /submit     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Data Submission Flow (CLI)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ccusage    â”‚â”€â”€â”€â”€â–¶â”‚  CLI Parse   â”‚â”€â”€â”€â”€â–¶â”‚  Validate    â”‚
â”‚  (raw data)  â”‚     â”‚  + Format    â”‚     â”‚  + Sanitize  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Leaderboard â”‚â—€â”€â”€â”€â”€â”‚   DB Insert  â”‚â—€â”€â”€â”€â”€â”‚  POST /api   â”‚
â”‚   Update     â”‚     â”‚  + RLS Check â”‚     â”‚  /submit     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Realtime    â”‚
â”‚  Broadcast   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Leaderboard Query Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚â”€â”€â”€â”€â–¶â”‚  Next.js     â”‚â”€â”€â”€â”€â–¶â”‚  TanStack    â”‚
â”‚  Request     â”‚     â”‚  RSC/Route   â”‚     â”‚  Query       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   Supabase Query             â”‚
                          â”‚   - Filter (period/country)  â”‚
                          â”‚   - Sort (tokens/cost)       â”‚
                          â”‚   - Paginate                 â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Component   â”‚â—€â”€â”€â”€â”€â”‚  TanStack    â”‚â—€â”€â”€â”€â”€â”‚  Supabase    â”‚
â”‚  Render      â”‚     â”‚  Cache       â”‚     â”‚  Response    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Security Architecture

### 5.1 Authentication Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layers                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Layer 1: Clerk Authentication                              â”‚
â”‚  â”œâ”€â”€ GitHub OAuth (secure token exchange)                   â”‚
â”‚  â”œâ”€â”€ JWT Session Management                                 â”‚
â”‚  â”œâ”€â”€ CSRF Protection                                        â”‚
â”‚  â””â”€â”€ Rate Limiting                                          â”‚
â”‚                                                             â”‚
â”‚  Layer 2: Next.js Middleware                                â”‚
â”‚  â”œâ”€â”€ Route Protection (clerkMiddleware)                     â”‚
â”‚  â”œâ”€â”€ Public Route Matcher                                   â”‚
â”‚  â””â”€â”€ Auth Header Injection                                  â”‚
â”‚                                                             â”‚
â”‚  Layer 3: Supabase RLS                                      â”‚
â”‚  â”œâ”€â”€ Row-level access control                               â”‚
â”‚  â”œâ”€â”€ clerk_id verification                                  â”‚
â”‚  â””â”€â”€ Service Role (server-only)                             â”‚
â”‚                                                             â”‚
â”‚  Layer 4: API Validation                                    â”‚
â”‚  â”œâ”€â”€ Zod Schema Validation                                  â”‚
â”‚  â”œâ”€â”€ Input Sanitization                                     â”‚
â”‚  â””â”€â”€ Rate Limiting (per user)                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 RLS Policy Overview

| Table | Read | Write | Policy |
|-------|------|-------|--------|
| users | Public (if visible) | Own only | clerk_id match |
| usage_stats | Public | Own only | user_id ownership |
| user_badges | Public | System only | Service role |
| news_items | Public | None | Read-only |
| country_stats | Public | None | Materialized |

---

## 6. Performance Strategy

### 6.1 Caching Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Caching Strategy                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. Vercel Edge Cache                                       â”‚
â”‚     - Static pages: ISR (revalidate: 60s)                   â”‚
â”‚     - OG images: Cache-Control: max-age=3600                â”‚
â”‚     - API responses: stale-while-revalidate                 â”‚
â”‚                                                             â”‚
â”‚  2. TanStack Query Cache                                    â”‚
â”‚     - Leaderboard: staleTime: 30s, gcTime: 5min             â”‚
â”‚     - Profile: staleTime: 60s, gcTime: 10min                â”‚
â”‚     - News: staleTime: 5min, gcTime: 30min                  â”‚
â”‚                                                             â”‚
â”‚  3. Supabase Connection Pool                                â”‚
â”‚     - pgBouncer: transaction mode                           â”‚
â”‚     - Max connections: 100                                  â”‚
â”‚                                                             â”‚
â”‚  4. Browser Cache                                           â”‚
â”‚     - Static assets: immutable                              â”‚
â”‚     - API: Cache-Control headers                            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Performance Targets

| Metric | Target | Strategy |
|--------|--------|----------|
| LCP | < 2.5s | RSC + Streaming |
| FID | < 100ms | Minimal client JS |
| CLS | < 0.1 | Reserved space |
| TTFB | < 500ms | Edge deployment |
| Bundle Size | < 150KB | Code splitting |

---

## 7. Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Deployment Flow                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   GitHub Repository                                         â”‚
â”‚        â”‚                                                    â”‚
â”‚        â”‚  push to main                                      â”‚
â”‚        â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚   Vercel CI/CD      â”‚                                   â”‚
â”‚   â”‚   - Build Next.js   â”‚                                   â”‚
â”‚   â”‚   - Run ESLint      â”‚                                   â”‚
â”‚   â”‚   - Type Check      â”‚                                   â”‚
â”‚   â”‚   - Deploy Edge     â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚        â”‚                                                    â”‚
â”‚        â”‚  Preview/Production                                â”‚
â”‚        â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚   Vercel Edge       â”‚â”€â”€â”€â”€â–¶â”‚   Supabase          â”‚      â”‚
â”‚   â”‚   (Global CDN)      â”‚     â”‚   (Database)        â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                             â”‚
â”‚   CLI Package (Separate)                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚   npm publish       â”‚                                   â”‚
â”‚   â”‚   - Build CLI       â”‚                                   â”‚
â”‚   â”‚   - Semantic Ver    â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Error Handling & Monitoring

### 8.1 Error Boundary Strategy

```typescript
// Component hierarchy
<ErrorBoundary fallback={<GlobalError />}>
  <Suspense fallback={<Loading />}>
    <Layout>
      <ErrorBoundary fallback={<PageError />}>
        <Suspense fallback={<PageSkeleton />}>
          <Page />
        </Suspense>
      </ErrorBoundary>
    </Layout>
  </Suspense>
</ErrorBoundary>
```

### 8.2 Monitoring Stack

| Tool | Purpose | Integration |
|------|---------|-------------|
| Sentry | Error tracking | `@sentry/nextjs` |
| Vercel Analytics | Web vitals | Built-in |
| Vercel Speed Insights | Performance | Built-in |
| Supabase Logs | DB queries | Dashboard |

---

## 9. Scalability Considerations

### 9.1 Database Scaling

- **Read Replicas**: Supabase Pro tier ì§€ì›
- **Connection Pooling**: pgBouncer í™œìš©
- **Materialized Views**: country_stats í…Œì´ë¸”
- **Daily Snapshots**: Historical data archiving

### 9.2 Traffic Scaling

- **Vercel**: Auto-scaling, Edge CDN
- **Supabase**: Connection pooling, Read replicas
- **Rate Limiting**: Per-user, Per-IP limits

---

## 10. Future Considerations

| Feature | Architecture Impact | Priority |
|---------|---------------------|----------|
| Teams | New tables, RLS expansion | Medium |
| API v2 | Versioned endpoints | Low |
| Mobile App | API reuse, Push notifications | Low |
| i18n | Next.js built-in | Medium |
| WebSocket scaling | Redis Pub/Sub | Low |

---

## 11. Admin System Architecture

### 11.1 Admin API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/admin/users` | GET | Get all users with stats |
| `/api/admin/ai-usage` | GET | Get AI usage stats (period filter) |
| `/api/admin/contents` | GET | List contents (filter by type/status) |
| `/api/admin/contents` | POST | Create new content |
| `/api/admin/contents/[id]` | GET/PATCH/DELETE | Individual content CRUD |
| `/api/admin/settings` | GET/PATCH | Automation settings |
| `/api/admin/crawl` | GET | Crawl status |
| `/api/admin/crawl` | POST | Trigger crawl (news/youtube) |

### 11.2 Automation Mode (3-Way Toggle)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Automation Modes                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ON:      Crawl â†’ Summarize â†’ Auto Publish                  â”‚
â”‚           (ì™„ì „ ìë™)                                         â”‚
â”‚                                                             â”‚
â”‚  CONFIRM: Crawl â†’ Summarize â†’ Admin Review â†’ Publish/Reject â”‚
â”‚           (ê²€í†  í•„ìš”)                                         â”‚
â”‚                                                             â”‚
â”‚  OFF:     Admin URL Input â†’ Process â†’ Publish               â”‚
â”‚           (ìˆ˜ë™ ëª¨ë“œ)                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3 Database Tables (Admin)

| Table | Purpose |
|-------|---------|
| contents | News/YouTube content storage |
| admin_settings | Automation mode, crawl intervals |
| ai_usage_log | AI API usage tracking |

---

**Document End**

*Architecture Version: 1.1*
*Last Updated: 2025-01-06*
